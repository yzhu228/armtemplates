{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.6.1.6515",
      "templateHash": "10632740152515088638"
    }
  },
  "parameters": {
    "apimName": {
      "type": "string"
    },
    "funcSiteName": {
      "type": "string"
    },
    "funcAppName": {
      "type": "string"
    }
  },
  "variables": {
    "funcKeyName": "[format('{0}-key', parameters('funcSiteName'))]",
    "policyContent": "<policies>\r\n    <inbound>\r\n        <base />\r\n        <set-backend-service id=\"apim-generated-policy\" backend-id=\"{funcAppName}\" />\r\n    </inbound>\r\n    <backend>\r\n        <base />\r\n    </backend>\r\n    <outbound>\r\n        <base />\r\n    </outbound>\r\n    <on-error>\r\n        <base />\r\n    </on-error>\r\n</policies>\r\n",
    "functionApiPolicy": "[replace(variables('policyContent'), '{funcAppName}', format('{0}', parameters('funcSiteName')))]"
  },
  "resources": [
    {
      "type": "Microsoft.Web/sites/host/functionKeys",
      "apiVersion": "2021-03-01",
      "name": "[format('{0}/default/apim-{1}', parameters('funcSiteName'), parameters('apimName'))]",
      "properties": {
        "name": "[format('apim-{0}', parameters('apimName'))]"
      }
    },
    {
      "type": "Microsoft.ApiManagement/service/namedValues",
      "apiVersion": "2021-08-01",
      "name": "[format('{0}/{1}', parameters('apimName'), variables('funcKeyName'))]",
      "properties": {
        "displayName": "[parameters('funcAppName')]",
        "value": "[reference(resourceId('Microsoft.Web/sites/host/functionKeys', split(format('{0}/default/apim-{1}', parameters('funcSiteName'), parameters('apimName')), '/')[0], split(format('{0}/default/apim-{1}', parameters('funcSiteName'), parameters('apimName')), '/')[1], split(format('{0}/default/apim-{1}', parameters('funcSiteName'), parameters('apimName')), '/')[2])).value]",
        "secret": true,
        "tags": [
          "key",
          "function",
          "auto",
          "arm"
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Web/sites/host/functionKeys', split(format('{0}/default/apim-{1}', parameters('funcSiteName'), parameters('apimName')), '/')[0], split(format('{0}/default/apim-{1}', parameters('funcSiteName'), parameters('apimName')), '/')[1], split(format('{0}/default/apim-{1}', parameters('funcSiteName'), parameters('apimName')), '/')[2])]"
      ]
    },
    {
      "type": "Microsoft.ApiManagement/service/backends",
      "apiVersion": "2021-08-01",
      "name": "[format('{0}/{1}', parameters('apimName'), parameters('funcSiteName'))]",
      "properties": {
        "description": "[parameters('funcSiteName')]",
        "protocol": "http",
        "url": "[format('https://{0}.azurewebsites.net/api', parameters('funcSiteName'))]",
        "resourceId": "[format('https://management.azure.com{0}', resourceId('Microsoft.Web/sites/functions', parameters('funcSiteName'), parameters('funcAppName')))]",
        "credentials": {
          "header": {
            "x-functions-key": [
              "[format('{{{{{0}}}}}', variables('funcKeyName'))]"
            ]
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimName'), variables('funcKeyName'))]"
      ]
    },
    {
      "type": "Microsoft.ApiManagement/service/apis",
      "apiVersion": "2021-08-01",
      "name": "[format('{0}/{1}', parameters('apimName'), 'tester-func-api')]",
      "properties": {
        "displayName": "Tester Function API",
        "path": "functionapi",
        "protocols": [
          "https"
        ],
        "apiType": "http",
        "isCurrent": true,
        "subscriptionRequired": false
      },
      "dependsOn": [
        "[resourceId('Microsoft.ApiManagement/service/backends', parameters('apimName'), parameters('funcSiteName'))]"
      ]
    },
    {
      "type": "Microsoft.ApiManagement/service/apis/policies",
      "apiVersion": "2021-08-01",
      "name": "[format('{0}/{1}/{2}', parameters('apimName'), 'tester-func-api', 'policy')]",
      "properties": {
        "value": "[variables('functionApiPolicy')]",
        "format": "xml"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ApiManagement/service/apis', parameters('apimName'), 'tester-func-api')]"
      ]
    },
    {
      "type": "Microsoft.Web/sites/config",
      "apiVersion": "2021-03-01",
      "name": "[format('{0}/{1}', parameters('funcSiteName'), 'web')]",
      "properties": {
        "apiManagementConfig": {
          "id": "[resourceId('Microsoft.ApiManagement/service/apis', parameters('apimName'), 'tester-func-api')]"
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.ApiManagement/service/apis', parameters('apimName'), 'tester-func-api')]"
      ]
    }
  ]
}